rm(list=ls())
library(ggplot2)
library(dplyr)
library(rwebppl)

##source("mailstuff.R")

exp.df <- read.csv("simexp.csv")
exp.df$ppntid <- exp.df$ppntid-1; #webppl is 0 indexed.

exp.df$expectA = exp.df$probA*exp.df$payoffA
exp.df$expectB = exp.df$probB*exp.df$payoffB
exp.df$expectC = exp.df$probC*exp.df$payoffC

##data frames arrive in webppl as an array of objects, each object is a row, with attributes colnames holding the values in that row.

timer <- system.time(
    fit  <- webppl(program_file="model.ppl",data=exp.df,data_var="expdf")
)

##Organize the return values for inspection. Be careful identifying things by their index in an array!
ppnt.params.df <- data.frame(
    ppnt_calcsd=c(),
    ppnt_tolerance_prob=c(),
    ppnt_tolerance_payoff=c(),
    ppnt_orderror=c()
)

pop.params.df <- data.frame(
    pop_calcsd_mean=c(),
    pop_calcsd_sd=c(),
    pop_tolerance_prob_mean=c(),
    pop_tolerance_prob_sd=c(),
    pop_tolerance_payoff_mean=c(),
    pop_tolerance_payoff_sd=c(),
    pop_orderror_mean=c(),
    pop_orderror_sd=c()
)

for(asample in fit$value){
    pop.row <- data.frame(
        pop_calcsd_mean=asample[[1]],
        pop_calcsd_sd=asample[[2]],
        pop_tolerance_prob_mean=asample[[3]],
        pop_tolerance_prob_sd=asample[[4]],
        pop_tolerance_payoff_mean=asample[[5]],
        pop_tolerance_payoff_sd=asample[[6]],
        pop_orderror_mean=asample[[7]],
        pop_orderror_sd=asample[[8]]
    )
    
    pop.params.df <- rbind(pop.params.df,pop.row)

    ppnt.row <- data.frame(ppntid=0:max(exp.df$ppntid),
                           ppnt_calcsd=asample[[9]],
                           ppnt_tolerance_prob=asample[[10]],
                           ppnt_tolerance_payoff=asample[[11]],
                           ppnt_orderror=asample[[12]]
                           )
    ppnt.params.df <- rbind(ppnt.params.df,ppnt.row)
}

##Final result: pop.params.df & ppnt.params.df
##Each contains samples for each value from the posterior, number of samples s set in 'model'.
##pop.params will have s rows, ppnt.params will have s*hm_ppnts rows, with no distinguishing features for samples from the same participant, all rows with a shared participant number go together to approximate a posterior.
